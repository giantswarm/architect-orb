executor: architect
parameters:
  app_catalog:
    description: "Name of the Github repository inside giantswarm organization hosting the App Catalog for tagged builds."
    type: "string"
  app_catalog_test:
    description: "Name of the Github repository inside giantswarm organization hosting the App Catalog for test builds."
    type: "string"
  attach_workspace:
    description: "If true, the previously persisted workspace will be attached after checkout."
    type: "boolean"
    default: false
  chart:
    description: "Name of the chart inside helm directory to push to the App Catalog."
    type: "string"
  on_tag:
    type: boolean
    default: true
    description: |
      When this is `false`, commits to `master` will be pushed to `app_catalog` instead of `app_catalog_test`.
      Set this to `false` for deployments that follow a a master branch for production releases rather than
      using tags (the default).
steps:
  - checkout
  - setup_remote_docker
  - when:
      condition: << parameters.attach_workspace >>
      steps:
        - attach_workspace:
            at: .
  - tools-info
  - prepare-catalogbot-git-ssh
  - helm-chart-template:
      chart: << parameters.chart >>
  - helm-lint:
      chart: "<< parameters.chart >>"
  - helm-conftest:
      chart: "<< parameters.chart >>"
  - package-and-push:
      app_catalog: << parameters.app_catalog >>
      app_catalog_test: << parameters.app_catalog_test >>
      chart: << parameters.chart >>
      on_tag: << parameters.on_tag >>
