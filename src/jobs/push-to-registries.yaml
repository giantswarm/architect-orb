environment:
  DOCKER_BUILDKIT: "1"
executor: "architect"
resource_class: "<< parameters.resource_class >>"
parameters:
  image:
    description: Name of the  container repository and image. Defaults to `giantswarm/REPO_NAME`. Must not contain registry host name!
    type: string
    default: "giantswarm/${CIRCLE_PROJECT_REPONAME}"
  tag-latest-branch:
    description: 'Name of the branch on which the image will be additionally tagged as "latest".'
    type: string
    default: main
  resource_class:
    default: small
    description: |
      Configures the amount of CPU and RAM for the job. See
      https://circleci.com/docs/2.0/configuration-reference/#docker-executor
      for details.
    type: enum
    enum: ["small", "medium", "medium+", "large", "xlarge"]
  build-context:
    type: string
    default: "."
  dockerfile:
    type: string
    default: "./Dockerfile"
  tag-suffix:
    type: string
    default: ""
  push-to-gsoci:
    description: |
      Whether images should be pushed to gsoci.azurecr.io (recommended!).
    type: boolean
    default: true
  push-dev-to-gsoci:
    description: Whether a dev image should be pushed to gsoci.azurecr.io.
    type: boolean
    default: true
  push-to-gsociprivate:
    description: |
      Whether images should be pushed to gsociprivate.azurecr.io. This will work only
      if hte source GitHub repository is detected as private as well.
    type: boolean
    default: true
  push-dev-to-gsociprivate:
    description: |
      Whether dev images should be pushed to gsociprivate.azurecr.io. This will work only
      if hte source GitHub repository is detected as private as well.
    type: boolean
    default: true
  push-to-quay:
    description: Whether images should be pushed to quay.io.
    type: boolean
    default: true
  push-dev-to-quay:
    description: Whether a dev image should be pushed to quay.io.
    type: boolean
    default: true
  push-to-aliyun:
    description: |
      Whether images should be pushed to the Aliyun registry (used only for AWS china).
      For dev images, also set `push-dev-to-aliyun` to true.
    type: boolean
    default: true
  push-dev-to-aliyun:
    description: Whether a dev image should be pushed to the Aliyun registry (used only for AWS china).
    type: boolean
    default: false
  push-to-docker:
    description: |
      Whether images image should be pushed to Docker Hub (docker.io).
      For dev images, also set `push-dev-to-docker` to true.
    type: boolean
    default: true
  push-dev-to-docker:
    description: Whether a dev image should be pushed to Docker Hub (docker.io).
    type: boolean
    default: false
  force-public:
    description: Skip the repo visibility check and push the the image to public registries
    type: boolean
    default: false
steps:
  - checkout
  - setup_remote_docker:
      version: default
  - attach_workspace:
      at: .
  - image-prepare-tag:
      tag-suffix: <<parameters.tag-suffix>>
  - image-build-with-docker:
      build-context: <<parameters.build-context>>
      dockerfile: <<parameters.dockerfile>>

  - image-push-to-registries:
      image-sha256_envvar: DOCKER_IMAGE_SHA256
      image: <<parameters.image>>
      tag_envvar: DOCKER_IMAGE_TAG
      build-context: <<parameters.build-context>>
      dockerfile: <<parameters.dockerfile>>
      # push-dev: <<parameters.push-dev-to-gsoci>>
      tag-latest-branch: <<parameters.tag-latest-branch>>
      tag-suffix: <<parameters.tag-suffix>>
      registries-data: |-
        private gsociprivate.azurecr.io ACR_GSOCIPRIVATE_USERNAME ACR_GSOCIPRIVATE_PASSWORD false
        public gsoci.azurecr.io ACR_GSOCI_USERNAME ACR_GSOCI_PASSWORD false
        private/public quay.io QUAY_USERNAME QUAY_PASSWORD true
        public giantswarm-registry.cn-shanghai.cr.aliyuncs.com ALIYUN_USERNAME ALIYUN_PASSWORD false
    #  # gsociprivate
    #  - when:
    #      condition:
    #        equal: [true, <<parameters.push-to-gsoci>>]
    #      steps:
    #        - image-push-to-registry:
    #            image-sha256_envvar: DOCKER_IMAGE_SHA256
    #            registry: gsociprivate.azurecr.io
    #            image: <<parameters.image>>
    #            tag_envvar: DOCKER_IMAGE_TAG
    #            username_envvar: ACR_GSOCIPRIVATE_USERNAME
    #            password_envvar: ACR_GSOCIPRIVATE_PASSWORD
    #            build-context: <<parameters.build-context>>
    #            dockerfile: <<parameters.dockerfile>>
    #            push-dev: <<parameters.push-dev-to-gsoci>>
    #            tag-latest-branch: <<parameters.tag-latest-branch>>
    #            tag-suffix: <<parameters.tag-suffix>>
    #            private-registries: "quay.io"
    #            private-only-registries: gsociprivate.azurecr.io
    #
    #  # gsoci
    #  - when:
    #      condition:
    #        equal: [true, <<parameters.push-to-gsoci>>]
    #      steps:
    #        - image-push-to-registry:
    #            image-sha256_envvar: DOCKER_IMAGE_SHA256
    #            registry: gsoci.azurecr.io
    #            image: <<parameters.image>>
    #            tag_envvar: DOCKER_IMAGE_TAG
    #            username_envvar: ACR_GSOCI_USERNAME
    #            password_envvar: ACR_GSOCI_PASSWORD
    #            build-context: <<parameters.build-context>>
    #            dockerfile: <<parameters.dockerfile>>
    #            push-dev: <<parameters.push-dev-to-gsoci>>
    #            tag-latest-branch: <<parameters.tag-latest-branch>>
    #            tag-suffix: <<parameters.tag-suffix>>
    #            force-public: <<parameters.force-public>>
    #            private-registries: "quay.io"
    #            private-only-registries: gsociprivate.azurecr.io
    #
    #  # quay
    #  - when:
    #      condition:
    #        equal: [true, <<parameters.push-to-quay>>]
    #      steps:
    #        - image-push-to-registry:
    #            image-sha256_envvar: DOCKER_IMAGE_SHA256
    #            registry: quay.io
    #            image: <<parameters.image>>
    #            tag_envvar: DOCKER_IMAGE_TAG
    #            username_envvar: QUAY_USERNAME
    #            password_envvar: QUAY_PASSWORD
    #            build-context: <<parameters.build-context>>
    #            dockerfile: <<parameters.dockerfile>>
    #            push-dev: <<parameters.push-dev-to-quay>>
    #            tag-latest-branch: <<parameters.tag-latest-branch>>
    #            tag-suffix: <<parameters.tag-suffix>>
    #            force-public: <<parameters.force-public>>
    #            private-registries: "quay.io"
    #            private-only-registries: gsociprivate.azurecr.io
    #
    #  # aliyun
    #  - when:
    #      condition:
    #        equal: [true, <<parameters.push-to-aliyun>>]
    #      steps:
    #        - image-push-to-registry:
    #            image-sha256_envvar: DOCKER_IMAGE_SHA256
    #            registry: giantswarm-registry.cn-shanghai.cr.aliyuncs.com
    #            image: <<parameters.image>>
    #            tag_envvar: DOCKER_IMAGE_TAG
    #            username_envvar: ALIYUN_USERNAME
    #            password_envvar: ALIYUN_PASSWORD
    #            build-context: <<parameters.build-context>>
    #            dockerfile: <<parameters.dockerfile>>
    #            push-dev: <<parameters.push-dev-to-aliyun>>
    #            tag-latest-branch: <<parameters.tag-latest-branch>>
    #            tag-suffix: <<parameters.tag-suffix>>
    #            force-public: <<parameters.force-public>>
    #            private-registries: "quay.io"
    #            private-only-registries: gsociprivate.azurecr.io
    #
    #  # docker
    #  - when:
    #      condition:
    #        equal: [true, <<parameters.push-to-docker>>]
    #      steps:
    #        - image-push-to-registry:
    #            image-sha256_envvar: DOCKER_IMAGE_SHA256
    #            registry: docker.io
    #            image: <<parameters.image>>
    #            tag_envvar: DOCKER_IMAGE_TAG
    #            username_envvar: DOCKER_USERNAME
    #            password_envvar: DOCKER_PASSWORD
    #            build-context: <<parameters.build-context>>
    #            dockerfile: <<parameters.dockerfile>>
    #            push-dev: <<parameters.push-dev-to-docker>>
    #            tag-latest-branch: <<parameters.tag-latest-branch>>
    #            tag-suffix: <<parameters.tag-suffix>>
    #            force-public: <<parameters.force-public>>
    #            private-registries: "quay.io"
    #            private-only-registries: gsociprivate.azurecr.io
