---
parameters:
  chart:
    type: "string"
description: Validate Kubernetes resources.
steps:
  - run:
      name: kubeval
      environment:
        KUBEVAL_SCHEMA_LOCATION: https://raw.githubusercontent.com/yannh/kubernetes-json-schema/411622f5e91bc54d3eff7b700661ba03f23f7729
        KUBERNETES_VERSIONS: 1.16.0 1.17.0 1.18.0 1.19.0 1.20.0
      command: |
        for v in $KUBERNETES_VERSIONS; do
          echo "Validating against kubernetes version $v"
          if [ -d "helm/<<parameters.chart>>/ci" ]; then
            for t in $(ls helm/<<parameters.chart>>/ci/*.yaml); do
              helm template --values $t helm/<<parameters.chart>> | kubeval --ignore-missing-schemas --kubernetes-version $v -
            done
          else
            helm template helm/<<parameters.chart>> | kubeval --ignore-missing-schemas --kubernetes-version $v -
          fi
        done
