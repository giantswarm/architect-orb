parameters:
  env-file:
    type: string
  test-dir:
    type: string
steps:
  - when:
      condition: << parameters.env-file >>
      steps:
        - run:
            name: "architect/integration-test-go-test: Process .env file"
            command: |
              cat << parameters.env-file >> | sed -e 's/^\(.\)/export \1/' | tee .env
  - unless:
      condition: << parameters.env-file >>
      steps:
        - run:
            name: "architect/integration-test-go-test: Prepare empty .env file"
            command: |
                touch .env
  - run:
      name: "architect/integration-test-go-test: Move code to $GOPATH"
      command: |
        # TODO remove this after switch to Go modules.
        mkdir -p $(go env GOPATH | cut -d ':' -f 1)/src/github.com/${CIRCLE_PROJECT_USERNAME}
        mv ~/project $(go env GOPATH | cut -d ':' -f 1)/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
  - run:
      name: "architect/integration-test-go-test: Run test"
      command: |
        # TODO remove `cd` line after switch to Go modules.
        cd  $(go env GOPATH | cut -d ':' -f 1)/src/github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}
        source .env && CGO_ENABLED=0 KUBECONFIG=~/.kube/config go test -tags k8srequired -timeout 20m -v ./<< parameters.test-dir >>
