description: >
  Generates and adds an App CR to an app-collection.
  Note: version will be detected automatically by architect.
parameters:
  app_name:
    type: "string"
  app_namespace:
    type: "string"
  app_catalog:
    type: "string"
  app_collection_repo:
    type: "string"
  disable_force_upgrade:
    type: "boolean"
  unique:
    type: "string"
steps:
  - run: |
        architect project version > .version
  - when:
      condition: <<parameters.unique>>
      steps:
        - run: |
              echo -n "<<parameters.app_name>>-unique" > .cr_name
  - unless:
      condition: <<parameters.unique>>
      steps:
        - run: |
              echo -n "<<parameters.app_name>>-$(cat .version)" | head -c 53 > .cr_name
  - run: |
        architect create appcr --name $(cat .cr_name) --app-name <<parameters.app_name>> --app-namespace <<parameters.app_namespace>> --app-version $(cat .version) --catalog <<parameters.app_catalog>> --disable-force-upgrade=<<parameters.disable_force_upgrade>> -o yaml > .app.yaml
  - run: |
        git clone -q --depth=1 --single-branch -b master git@github.com:giantswarm/<<parameters.app_collection_repo>>.git .app-collection
  - run: |
        mkdir -p .app-collection/helm/<<parameters.app_collection_repo>>-chart/templates
  - when:
      condition: <<parameters.unique>>
      steps:
        - run: |
              cd .app-collection && git rm --ignore-unmatch helm/<<parameters.app_collection_repo>>-chart/templates/<<parameters.app_name>>-*.yaml
        - run: |
              echo -n "<<parameters.app_name>>-unique.yaml" > .app_file_name
        - run: |
              echo -n "update <<parameters.app_name>>-unique to $(cat .version)" > .git_commit_message
  - unless:
      condition: <<parameters.unique>>
      steps:
        - run: |
              echo -n "<<parameters.app_name>>-$(cat .version).yaml" > .app_file_name
        - run: |
              echo -n "add <<parameters.app_name>>-$(cat .version)" > .git_commit_message
  - run: |
        mv -n .app.yaml .app-collection/helm/<<parameters.app_collection_repo>>-chart/templates/$(cat .app_file_name)
  - run: |
        cd .app-collection && git add helm/<<parameters.app_collection_repo>>-chart/templates/$(cat ../.app_file_name)
  - run: |
        cd .app-collection && git commit -m "$(cat ../.git_commit_message)"
  - run: |
        cd .app-collection && \
        declare -i attempt=0 && \
        while ! git push; do
          attempt+=1
          if ((attempt >= 4)); then
            printf '%s\n' \
              "Error pushing app to the collection. See known errors in:" \
              "https://github.com/giantswarm/architect-orb/blob/master/README.md#push-to-app-collection" \
              "Giving up after $attempt failures." \
              >&2
            exit 1
          fi
          sleep 5
          git pull --rebase --autostash
        done
  - run: |
        rm .cr_name .version .app_file_name .git_commit_message

