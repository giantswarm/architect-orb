parameters:
  custom_tag:
    type: "string"
  image:
    type: "string"
  password_envar:
    type: "string"
  username_envar:
    type: "string"
  tag-latest-branch:
    type: "string"
steps:
  - run: |
      echo -n "<<parameters.image>>:$(architect project version)" > .docker_image_name
  - run: |
      echo -n "${<<parameters.password_envar>>}" | docker login --username "${<<parameters.username_envar>>}" --password-stdin "$(echo -n '<<parameters.image>>' | cut -d/ -f1)"
  - run: |
      docker build -t "$(cat .docker_image_name)" .
  - run: |
      docker push "$(cat .docker_image_name)"
  - run: |
      ! [[ "<<parameters.tag-latest-branch>>" == "${CIRCLE_BRANCH}" ]] && echo "skip" || docker tag "$(cat .docker_image_name)" "<<parameters.image>>:latest"
  - run: |
      ! [[ "<<parameters.tag-latest-branch>>" == "${CIRCLE_BRANCH}" ]] && echo "skip" || docker push "<<parameters.image>>:latest"
  - run: |
      ! [[ "<<parameters.custom_tag>>" == "" ]] && echo "skip" || docker tag "$(cat .docker_image_name)" "<<parameters.image>>:<<parameters.custom_tag>>"
