parameters:
  app_catalog:
    type: "string"
  app_catalog_test:
    type: "string"
  chart:
    type: "string"
  production_branch:
    type: string
    description: |
      When this is a non-empty string, commits on the given branch will be treated as production releases
      and the helm chart will be pushed to `app_catalog` instead of `app_catalog_test`. Use this for deployments
      that follow a trunk branch (usually `master`) for production releases rather than using tags.
steps:
  - unless:
      condition: << parameters.production_branch >>
      steps:
        - run:
            name: "architect/package-and-push: Determine target app catalog based on presence of tag"
            command: |
              [ -z ${CIRCLE_TAG} ] && echo -n '<< parameters.app_catalog_test >>' > .app_catalog_name || echo -n '<< parameters.app_catalog >>' > .app_catalog_name
  - when:
      condition: << parameters.production_branch >>
      steps:
        - run:
            name: "architect/package-and-push: Determine target app catalog based on branch name"
            command: |
              [[ <<parameters.production_branch>> == ${CIRCLE_BRANCH} ]] && echo -n '<< parameters.app_catalog >>' > .app_catalog_name || echo -n '<< parameters.app_catalog_test >>' > .app_catalog_name
  - run: |
      [[ << parameters.chart >> == ${CIRCLE_PROJECT_REPONAME}* ]] && exit 0 || echo "chart parameter value must start with ${CIRCLE_PROJECT_REPONAME}" ; exit 1
  - run: |
      git clone -q --depth=1 --single-branch -b master "git@github.com:giantswarm/$(cat .app_catalog_name).git" .app_catalog
  - run: |
      helm init --client-only
  - run: |
      mkdir build && helm package ./helm/<< parameters.chart >> --destination ./build
  - run: |
      helm repo index --url https://giantswarm.github.com/$(cat .app_catalog_name) --merge .app_catalog/index.yaml ./build
  - run: |
      cp ./build/* .app_catalog
  - run: |
      cd .app_catalog && git add -A
  - run: |
      cd .app_catalog && git commit -m "add $(git status --porcelain | cut -c4- | grep << parameters.chart >>)"
  - run: |
      cd .app_catalog && git push || (echo "Error pushing app to the catalog. See known errors in https://github.com/giantswarm/architect-orb/blob/master/README.md#push-to-app-catalog" && exit 1)

