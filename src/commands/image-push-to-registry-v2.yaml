# This command checks whether the tag represents a dev or release build
# and then decides whether a push should happen.
# The :latest tag is also pushed if conditions match.

parameters:
  image_sha256:
    type: string
  registry:
    type: string
  image:
    description: Name of the repository and image, e. g. giantswarm/my-project. Defaults to the org and repo name separated with a slash.
    type: string
  tag:
    type: string
  password_envar:
    type: env_var_name
  username_envar:
    type: env_var_name
  push_dev_builds:
    description: "Normally only release builds are pushed. If this is true, also dev builds are pushed to the selected registry."
    type: boolean
    default: false
  tag-latest-branch:
    type: string
  tag-suffix:
    type: string
    default: ""
  build-context:
    type: string
    default: "."
  dockerfile:
    type: string
    default: "./Dockerfile"
steps:
    - run:
        name: Push to registry <<parameters.registry>>
        command: |
          BUILD_TYPE=dev
          MATCH=$(echo "<< parameters.tag >>" | grep -E "[a-h0-9]{40}")
          if [[ -z "$MATCH" ]]; then
            # Release build
            BUILD_TYPE=release
          fi

          echo "Pushing dev builds (push_dev_builds) for this registry is set to: <<parameters.push_dev_builds>>"
          echo "The type of this build is: $BUILD_TYPE"

          if [ "$BUILD_TYPE" = "dev" ]; then
            if [ "<<parameters.push_dev_builds>>" = "false" ]; then
              echo "As this is a dev build, and dev builds should not be pushed to this registry, ending here."
              exit 0
            fi
          fi

          # Default the image name
          IMAGE="<<parameters.image>>"
          if [[ -z "$IMAGE" ]]; then
            IMAGE="$CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME"
          fi

          echo "Tagging image with SHA256 <<parameters.image_sha256>> as <<parameters.registry>>/${IMAGE}:<<parameters.tag>>"
          docker tag <<parameters.image_sha256>> "<<parameters.registry>>/${IMAGE}:<<parameters.tag>>"

          echo "Authenticating for registry <<parameters.registry>>"
          docker login <<parameters.registry>> --username "${<<parameters.username_envar>>}" --password "${<<parameters.password_envar>>}"

          echo "Pushing the image"
          docker push -q "<<parameters.registry>>/${IMAGE}:<<parameters.tag>>" || docker push -q "<<parameters.registry>>/${IMAGE}:<<parameters.tag>>" || docker push -q "<<parameters.registry>>/${IMAGE}:<<parameters.tag>>"

          if [ "$CIRCLE_BRANCH" = "<<parameters.tag-latest-branch>>" ]; then
            echo "Also push the image with :latest<<parameters.tag-suffix>> tag (only for branch <<parameters.tag-latest-branch>>)"
            docker tag <<parameters.image_sha256>> "<<parameters.registry>>/${IMAGE}:latest"
            docker push "${IMAGE}:latest<<parameters.tag-suffix>>"
          fi
