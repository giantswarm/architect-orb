steps:
  - go-gen-ldflags
  - name: Check if go.mod & go.sum are up to date
    run: |
      go mod tidy && git diff --exit-code
  - run:
      name: Check if imports are properly sorted
      command: |
        go install golang.org/x/tools/cmd/goimports@latest && if [[ -n $(goimports -local github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME} -l .) ]]; then goimports -local github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME} -d . && exit 1; fi
  - run: |
      test -z $(gofmt -l .) || gofmt -d .
  - run: |
      CGO_ENABLED=0 go vet ./...
  - run: |
      CGO_ENABLED=0 golangci-lint run -E gosec -E goconst
  - run: |
      CGO_ENABLED=0 go list -json -m all | nancy sleuth --skip-update-check --quiet
  - run: |
      CGO_ENABLED=0 go test -ldflags "$(cat .ldflags)" ./...
