parameters:
  binary:
    description: "If not empty, the path to the given binary relative to the working directory will be persisted to the workspace."
    type: "string"
  command:
    description: "Command to be run by architect. Should usually be 'build' or 'deploy'."
    type: "string"
steps:
  - run:
      name: "architect/go-architect-legacy: Executing architect command"
      command: |
        docker run \
          -e CIRCLE_PROJECT_REPONAME \
          -e CIRCLE_PROJECT_USERNAME \
          -e CIRCLECI \
          -e QUAY_USERNAME \
          -e QUAY_PASSWORD \
          -e DEPLOYMENT_EVENTS_TOKEN \
          -e CGO_ENABLED=0 \
          -v /home/circleci/project:/home/circleci/project \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -w /home/circleci/project \
          quay.io/giantswarm/architect << parameters.command >>
  - when:
      condition: << parameters.binary >>
      steps:
        - persist_to_workspace:
            root: .
            paths:
              - ./<< parameters.binary >>
