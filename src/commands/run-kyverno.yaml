parameters:
  chart:
    type: "string"
  kyverno_version:
    description: "Version of Kyverno CLI to use"
    type: string
  kyverno-policies_version:
    description: "Version of Kyverno policies to use"
    type: string
steps:
  - attach_workspace:
      at: build
  - run:
      name: "Install helm"
      command: |
        curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        chmod 700 get_helm.sh
        ./get_helm.sh
  - run:
      name: "Download Kyverno cli"
      command: |
        curl -sLO "https://github.com/kyverno/kyverno/releases/download/v<< parameters.kyverno_version >>/kyverno-cli_v<< parameters.kyverno_version >>_linux_x86_64.tar.gz"
        tar -xvf kyverno-cli_v<< parameters.kyverno_version >>_linux_x86_64.tar.gz
        sudo cp kyverno /usr/local/bin/
  - run:
      name: "Template Kyverno policies"
      command: |
        mkdir -p manifests/policies

        # template the kyverno policies
        helm template https://giantswarm.github.io/giantswarm-catalog/kyverno-policies-<< parameters.kyverno-policies_version >>.tgz > manifests/policies/kyverno-policies.yaml
  - run:
      name: "Template Helm chart"
      command: |
        mkdir -p manifests/resources

        # template the helm chart
        helm template --release-name <<parameters.chart>> helm/<<parameters.chart>> > manifests/resources/<<parameters.chart>>.yaml
  - run:
      name: "Run Kyverno apply"
      command: |
        set +x

        kyverno apply manifests/policies/kyverno-policies.yaml \
          --resource manifests/resources/<<parameters.chart>>.yaml \
          --exceptions-with-resources || \
        {
            echo "Policies failed, generating exceptions...";
            kyverno apply manifests/policies/kyverno-policies.yaml \
              --resource manifests/resources/<<parameters.chart>>.yaml \
              --exceptions-with-resources --generate-exceptions;
            exit 1
        }
