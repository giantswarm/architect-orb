parameters:
  image-sha256_envvar:
    type: "env_var_name"
  registry:
    type: string
  image:
    type: "string"
  tag_envvar:
    type: "env_var_name"
  password_envvar:
    type: "env_var_name"
  username_envvar:
    type: "env_var_name"
  tag-latest-branch:
    type: "string"
  tag-suffix:
    type: "string"
    default: ""
  build-context:
    type: "string"
    default: "."
  dockerfile:
    type: "string"
    default: "./Dockerfile"
  push-dev:
    type: boolean
    default: false
steps:
  - run:
      name: DEBUG CMD
      command: |
        echo "${<<parameters.tag_envvar>>}"
  - run:
      name: Push image to <<parameters.registry>>
      command: |
        echo "Authenticate"
        echo -n "${<<parameters.password_envvar>>}" | docker login --username "${<<parameters.username_envvar>>}" --password-stdin "<<parameters.registry>>"

        echo "Tag the image for <<parameters.registry>>"
        docker tag "${<<parameters.image-sha256_envvar>>}" "<<parameters.registry>>/<<parameters.image>>:${<<parameters.tag>>}"

        echo "Pushing image with SHA256 ${<<parameters.image-sha256_envvar>>} as <<parameters.registry>>/<<parameters.image>>:${<<parameters.tag_envvar}>>"
        docker push "<<parameters.registry>>/<<parameters.image>>:${<<parameters.tag_envvar>>}" || docker push "<<parameters.registry>>/<<parameters.image>>:${<<parameters.tag_envvar>>}" || docker push "<<parameters.registry>>/<<parameters.image>>:${<<parameters.tag_envvar>>}"

  - when:
      condition:
        equal: [<<parameters.tag-latest-branch>>, "${CIRCLE_BRANCH}"]
      steps:
        - run:
            name: "When parameter 'tag-latest-branch' matches this branch: Retag the image as 'latest'"
            command: |
              docker tag "${<<parameters.image-sha256_envvar>>}" "<<parameters.registry>>/<<parameters.image>>:latest<<parameters.tag-suffix>>"
        - run:
            name: "When parameter 'tag-latest-branch' matches this branch: Push the 'latest' image to the container registry"
            command: |
              docker push "<<parameters.registry>>/<<parameters.image>>:latest<<parameters.tag-suffix>>"
